---
layout: post
title: 部署的噩梦
---
昨天计划今天升级，上午先部署到内网测试环境，下午验证下功能，没大问题的的话晚上就发布到正式环境。因为这个版本已经在外网测试环境测试过，内网验证测试应该比较顺利。 实际情况是，准备部署包，数据库更新花了一个上午，下午2:20才开始部署权限模块，因为部署包打的有问题，一直搞到5点多，才把权限模块部署好，接着部署其他组件模块，折腾到晚上7点才把内网测试环境部署好。 接下来开始验证测试，还是碰到好几个问题。因为时间关系，等不及测试环境验证完，直接往生产环境上更新。 所幸在生产环境上验证比较顺利，最后11:30手工。

**反思**
1. 这次版本的改动没有考虑到后兼容性，导致很多数据表要重建，数据迁移花费很多精力。
2. 部署流程需要优化，每次部署都要重新打包，因为vpn网络问题以及打包路径问题浪费了一个上午。
3. 外网测试通过的功能，部署到内网，还是出现很多的问题。这个需要总结下原因
4. 因为历史原因，内网测试环境和正式环境的数据库没有保持一致，导致更新脚本不能直接在正式环境运行。

**后续行动**
1. 梳理、优化部署流程，目标：1小时内完成系统的升级部署。
2. 明确版本打包流程，固化各环境的配置文件。做到一次打包，各个环境都通用。
